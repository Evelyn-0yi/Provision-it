<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Trading Center - Asset Trading Platform</title>
  <link rel="stylesheet" href="common.css">
</head>
<body>
  <nav class="nav">
    <div class="container">
      <div class="nav-content">
        <h1>Trading Center</h1>
        <div class="nav-links">
          <a href="dashboard.html">Dashboard</a>
          <a href="browsing.html">Browse Assets</a>
          <a href="trading.html" class="active">Trading</a>
          <a href="portfolio.html">My Assets</a>
          <a href="valuehistory.html">Value History</a>
          <a href="profile.html">Profile</a>
          <a href="admin.html" id="adminLink" style="display:none;">Admin</a>
          <button onclick="logout()" class="small">Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <div>
        <h2>Asset Trading</h2>
        <p class="text-muted">View and execute trades on available offers</p>
      </div>
      <div class="row">
        <select id="assetFilter" onchange="loadOffers()" style="margin-right: 10px;">
          <option value="">Select Asset</option>
        </select>
        <button onclick="loadOffers()" class="small">Refresh</button>
      </div>
    </div>

    <!-- Message Display -->
    <div id="messageContainer" style="margin-bottom: 20px;"></div>

    <!-- Offers Table -->
    <div class="card">
      <div class="row" style="justify-content: space-between; margin-bottom: 20px;">
        <h3>Available Offers</h3>
        <span class="text-muted" id="offersCount">0 offers</span>
      </div>
      
      <div id="offersTable">
        <div class="text-muted text-center" style="padding: 40px;">
          <div class="spinner"></div>
          <p>Loading offers...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = 'http://localhost:5000';
    const user = JSON.parse(sessionStorage.getItem('user') || '{}');
    let assets = [];
    let currentAssetId = null;
    
    // Check if user is manager
    if (user.is_manager) {
      document.getElementById('adminLink').style.display = 'inline-block';
    }

    // Load assets for dropdown
    async function loadAssets() {
      try {
        const response = await fetch(`${API}/assets`);
        const data = await response.json();
        
        if (data.status === 'success') {
          assets = data.assets || [];
          populateAssetDropdown();
          
          // Auto-select first asset
          if (assets.length > 0) {
            document.getElementById('assetFilter').value = assets[0].asset_id;
            currentAssetId = assets[0].asset_id;
            loadOffers();
          }
        }
      } catch (error) {
        console.error('Error loading assets:', error);
        showMessage('Failed to load assets', false);
      }
    }

    function populateAssetDropdown() {
      const select = document.getElementById('assetFilter');
      select.innerHTML = '<option value="">Select Asset</option>';
      
      assets.forEach(asset => {
        const option = document.createElement('option');
        option.value = asset.asset_id;
        option.textContent = asset.asset_name;
        select.appendChild(option);
      });
    }

    // Load offers for selected asset
    async function loadOffers() {
      const assetId = document.getElementById('assetFilter').value;
      
      if (!assetId) {
        document.getElementById('offersTable').innerHTML = '<p class="text-muted text-center" style="padding: 40px;">Please select an asset to view offers</p>';
        return;
      }
      
      currentAssetId = assetId;
      
      document.getElementById('offersTable').innerHTML = '<div class="text-muted text-center" style="padding: 40px;"><div class="spinner"></div><p>Loading offers...</p></div>';
      
      try {
        const response = await fetch(`${API}/trading/offers/${assetId}`);
        const data = await response.json();
        
        if (data.status === 'success') {
          displayOffers(data.buy_offers, data.sell_offers);
          const totalCount = data.buy_count + data.sell_count;
          document.getElementById('offersCount').textContent = `${totalCount} offers`;
        } else {
          document.getElementById('offersTable').innerHTML = '<p class="text-muted text-center" style="padding: 40px;">Failed to load offers</p>';
        }
      } catch (error) {
        console.error('Error loading offers:', error);
        document.getElementById('offersTable').innerHTML = '<p class="text-muted text-center" style="padding: 40px;">Error loading offers</p>';
      }
    }

    function displayOffers(buyOffers, sellOffers) {
      const container = document.getElementById('offersTable');
      
      // Combine all offers and add type
      const allOffers = [
        ...buyOffers.map(o => ({ ...o, type: 'buy' })),
        ...sellOffers.map(o => ({ ...o, type: 'sell' }))
      ];
      
      // Sort by price (highest first)
      allOffers.sort((a, b) => b.price_perunit - a.price_perunit);
      
      if (allOffers.length === 0) {
        container.innerHTML = '<p class="text-muted text-center" style="padding: 40px;">No offers available for this asset</p>';
        return;
      }
      
      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Type</th>
              <th>Price per Unit</th>
              <th>Units</th>
              <th>Total Value</th>
              <th>User</th>
              <th>Created</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            ${allOffers.map(offer => {
              const actionButton = offer.type === 'buy' 
                ? `<button onclick="executeTrade(${offer.offer_id})" class="small danger">SELL</button>`
                : `<button onclick="executeTrade(${offer.offer_id})" class="small success">BUY</button>`;
              
              return `
                <tr>
                  <td>
                    <span class="badge ${offer.type === 'buy' ? 'success' : 'error'}">${offer.type.toUpperCase()}</span>
                  </td>
                  <td>짜${offer.price_perunit.toFixed(2)}</td>
                  <td>${offer.units}</td>
                  <td>짜${offer.total_value.toFixed(2)}</td>
                  <td>User #${offer.user_id}</td>
                  <td class="text-muted">${formatDate(offer.created_at)}</td>
                  <td>${actionButton}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    async function executeTrade(offerId) {
      if (!confirm('Are you sure you want to execute this trade?')) {
        return;
      }
      
      try {
        const response = await fetch(`${API}/trading/execute`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            offer_id: offerId,
            user_id: user.user_id
          })
        });
        
        const data = await response.json();
        
        if (response.ok && data.status === 'success') {
          showMessage(
            `Trade executed successfully! ${data.trade.units_traded} units @ 짜${data.trade.price_perunit.toFixed(2)} = 짜${data.trade.total_value.toFixed(2)}`,
            true
          );
          
          // Reload offers after 2 seconds
          setTimeout(() => loadOffers(), 2000);
        } else {
          showMessage('Trade failed: ' + (data.message || 'Unknown error'), false);
        }
      } catch (error) {
        console.error('Error executing trade:', error);
        showMessage('Network error, please try again', false);
      }
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    function showMessage(message, isSuccess) {
      const container = document.getElementById('messageContainer');
      const msgClass = isSuccess ? 'ok' : 'err';
      
      container.innerHTML = `
        <div class="msg ${msgClass}" style="padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          ${message}
        </div>
      `;
      
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }

    function logout() {
      sessionStorage.removeItem('user');
      location.href = 'login.html';
    }

    // Load data on page load
    window.onload = () => {
      if (!user.user_id) {
        location.href = 'login.html';
        return;
      }
      loadAssets();
    };
  </script>
</body>
</html>