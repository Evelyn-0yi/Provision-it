<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard - Asset Trading Platform</title>
  <link rel="stylesheet" href="common.css">
</head>
<body>
  <nav class="nav">
    <div class="container">
      <div class="nav-content">
        <h1>Asset Trading Platform</h1>
        <div class="nav-links">
          <a href="browsing.html">Browse Assets</a>
          <a href="trading.html">Trading</a>
          <a href="portfolio.html">My Assets</a>
          <a href="valuehistory.html">Value History</a>
          <a href="profile.html">Profile</a>
          <a href="admin.html" id="adminLink" style="display:none;">Admin</a>
          <button onclick="logout()" class="small">Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <div>
        <h2>Welcome back, <span id="userName">User</span></h2>
        <p class="text-muted">View your asset overview and latest updates</p>
      </div>
      <div class="row">
        <button onclick="refreshData()" class="small">Refresh Data</button>
        <button onclick="location.href='trading.html'" class="primary small">Start Trading</button>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid">
      <div class="card">
        <h3>Total Asset Value</h3>
        <div style="font-size: 24px; font-weight: bold; color: var(--accent);" id="totalValue">$0</div>
        <p class="text-muted">vs Yesterday <span id="valueChange" class="text-success">+0%</span></p>
      </div>
      
      <div class="card">
        <h3>Assets Held</h3>
        <div style="font-size: 24px; font-weight: bold;" id="assetCount">0</div>
        <p class="text-muted">Different Assets</p>
      </div>
      
      <div class="card">
        <h3>Monthly Trades</h3>
        <div style="font-size: 24px; font-weight: bold;" id="monthlyTrades">0</div>
        <p class="text-muted">Transactions</p>
      </div>
      
      <div class="card">
        <h3>Pending</h3>
        <div style="font-size: 24px; font-weight: bold;" id="pendingTrades">0</div>
        <p class="text-muted">Pending Transactions</p>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="card">
      <h3>Recent Activity</h3>
      <div id="recentActivity">
        <div class="text-muted text-center" style="padding: 40px;">
          <div class="spinner"></div>
          <p>Loading...</p>
        </div>
      </div>
    </div>

    <!-- Top Assets -->
    <div class="card">
      <h3>Top Assets</h3>
      <div id="topAssets">
        <div class="text-muted text-center" style="padding: 40px;">
          <div class="spinner"></div>
          <p>Loading...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = 'http://localhost:5001'; // Backend API server
    const user = JSON.parse(sessionStorage.getItem('user') || '{}');
    
    // Check if user is manager
    if (user.is_manager) {
      document.getElementById('adminLink').style.display = 'inline-block';
    }
    
    document.getElementById('userName').textContent = user.user_name || 'User';

    async function fetchDashboardData() {
      try {
        // Fetch user data
        const userRes = await fetch(`${API}/users/${user.user_id}`, {
          credentials: 'include'
        });
        const userData = await userRes.json();
        
        // Fetch recent transactions
        const transactionsRes = await fetch(`${API}/transactions?user_id=${user.user_id}&limit=5`, {
          credentials: 'include'
        });
        const transactions = await transactionsRes.json();
        
        // Fetch top assets
        const assetsRes = await fetch(`${API}/assets?limit=5`, {
          credentials: 'include'
        });
        const assets = await assetsRes.json();
        
        updateDashboard(portfolio, transactions, assets);
      } catch (error) {
        console.error('Error fetching dashboard data:', error);
        showError('Failed to load data, please try again later');
      }
    }

    function updateDashboard(portfolio, transactions, assets) {
      // Update stats
      const totalValue = portfolio.total_value || 0;
      document.getElementById('totalValue').textContent = `$${totalValue.toLocaleString()}`;
      document.getElementById('assetCount').textContent = portfolio.asset_count || 0;
      document.getElementById('monthlyTrades').textContent = portfolio.monthly_trades || 0;
      document.getElementById('pendingTrades').textContent = portfolio.pending_trades || 0;
      
      // Update value change (mock data)
      const change = Math.random() * 10 - 5; // Random change between -5% and +5%
      const changeElement = document.getElementById('valueChange');
      changeElement.textContent = `${change > 0 ? '+' : ''}${change.toFixed(2)}%`;
      changeElement.className = change > 0 ? 'text-success' : 'text-error';
      
      // Update recent activity
      updateRecentActivity(transactions);
      
      // Update top assets
      updateTopAssets(assets);
    }

    function updateRecentActivity(transactions) {
      const container = document.getElementById('recentActivity');
      
      if (!transactions || transactions.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No recent activity</p>';
        return;
      }
      
      container.innerHTML = transactions.map(tx => `
        <div class="row" style="padding: 12px; border-bottom: 1px solid var(--border);">
          <div class="col">
            <div style="font-weight: 500;">${tx.transaction_type || 'Trade'}</div>
            <div class="text-muted" style="font-size: 12px;">${new Date(tx.transaction_at).toLocaleString()}</div>
          </div>
          <div class="text-right">
            <div class="${tx.unit_moved > 0 ? 'text-success' : 'text-error'}">
              ${tx.unit_moved > 0 ? '+' : ''}${tx.unit_moved} Units
            </div>
          </div>
        </div>
      `).join('');
    }

    function updateTopAssets(assets) {
      const container = document.getElementById('topAssets');
      
      if (!assets || assets.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No asset data available</p>';
        return;
      }
      
      container.innerHTML = assets.map(asset => `
        <div class="row" style="padding: 12px; border-bottom: 1px solid var(--border);">
          <div class="col">
            <div style="font-weight: 500;">${asset.asset_name}</div>
            <div class="text-muted" style="font-size: 12px;">Total Value: $${parseFloat(asset.total_value).toLocaleString()}</div>
          </div>
          <div class="text-right">
            <div class="text-success">+${(Math.random() * 5).toFixed(2)}%</div>
            <div class="text-muted" style="font-size: 12px;">Today's Change</div>
          </div>
        </div>
      `).join('');
    }

    function refreshData() {
      document.getElementById('recentActivity').innerHTML = `
        <div class="text-muted text-center" style="padding: 40px;">
          <div class="spinner"></div>
          <p>Refreshing...</p>
        </div>
      `;
      document.getElementById('topAssets').innerHTML = `
        <div class="text-muted text-center" style="padding: 40px;">
          <div class="spinner"></div>
          <p>Refreshing...</p>
        </div>
      `;
      fetchDashboardData();
    }

    function showError(message) {
      const container = document.getElementById('recentActivity');
      container.innerHTML = `<div class="msg err">${message}</div>`;
    }

    async function logout() {
      try {
        await fetch(`${API}/auth/logout`, { 
        method: 'POST',
        credentials: 'include'
      });
      } catch (e) {
        console.error('Logout error:', e);
      }
      sessionStorage.clear();
      location.href = 'login.html';
    }

    // Load data on page load
    fetchDashboardData();
  </script>
</body>
</html>

